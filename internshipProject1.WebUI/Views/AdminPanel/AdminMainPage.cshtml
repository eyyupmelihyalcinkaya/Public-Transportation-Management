@{
    ViewData["Title"] = "Admin Panel";
}

@section Scripts {
    <script>
        // Sayfa yüklendiğinde çalışacak kod
        document.addEventListener('DOMContentLoaded', function() {
            // localStorage'dan token'ı al
            const token = localStorage.getItem('token');
            
            // Token yoksa veya geçersizse giriş sayfasına yönlendir
            if (!token || token === 'null' || token === '""' || token === 'undefined') {
                console.log('No valid token found, redirecting to login...');
                window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            try {
                // Token'ı parse et
                const tokenData = JSON.parse(token);
                console.log('Token data:', tokenData);
                
                // SuperAdmin (1) veya Admin (2) değilse erişim engelle
                if (!tokenData.role || (tokenData.role !== 1 && tokenData.role !== 2)) {
                    console.log('User is not an admin or superadmin, redirecting to user dashboard...');
                    alert('Bu sayfaya erişim yetkiniz yok. Sadece Admin ve SuperAdmin kullanıcıları erişebilir.');
                    window.location.href = '/User/Dashboard';
                    return;
                }
                
                // RBAC menü kontrolü - kullanıcının izinlerine göre menüleri göster/gizle
                initializeRBACMenus(tokenData);
            } catch (e) {
                console.error('Error parsing token:', e);
                window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
            }
        });
    </script>
    <script>
        // Admin Panel JavaScript Functions
        
        // Pagination ve pageSize için state
        let routesPage = 1;
        let routesPageSize = 10;
        let stopsPage = 1;
        let stopsPageSize = 10;
        let tripsPage = 1;
        let tripsPageSize = 10;
        let routeStopsPage = 1;
        let routeStopsPageSize = 10;

         
         let routesTotal = 0;
         let stopsTotal = 0;
         let tripsTotal = 0;
         let routeStopsTotal = 0;

        // PageSize değişince
        function changePageSize(tab) {
            const size = parseInt(document.getElementById(tab + 'PageSize').value);
            if (tab === 'routes') {
                routesPageSize = size;
                routesPage = 1;
                loadRoutes();
            }
            else if (tab === 'stops') {
                stopsPageSize = size;
                stopsPage = 1;
                loadStops();
            }
            else if (tab === 'trips') {
                tripsPageSize = size;
                tripsPage = 1;
                loadTrips();
            }
            else if (tab === 'routeStops') {
                routeStopsPageSize = size;
                routeStopsPage = 1;
                loadRouteStops();
            }
        }

        // Sayfa değişince
        function changePage(tab, newPage) {
            if (tab === 'routes') {
                routesPage = newPage;
                loadRoutes();
            }
            else if (tab === 'stops') {
                stopsPage = newPage;
                loadStops();
            }
            else if (tab === 'trips') {
                tripsPage = newPage;
                loadTrips();
            }
            else if (tab === 'routeStops') {
                routeStopsPage = newPage;
                loadRouteStops();
            }
        }

        // Routes için parametreli yükleme
        async function loadRoutes() {
            try {
                const response = await fetch(`/AdminPanel/GetRoutes?page=${routesPage}&pageSize=${routesPageSize}`);
                if (response.ok) {
                    const data = await response.json();
                    updateRoutesTable(data.items || data);
                    updateRoutesPagination();
                } else {
                    showToast('Failed to load routes', 'error');
                }
            } catch (error) {
                console.error('Error loading routes:', error);
                showToast('Connection error while loading routes', 'error');
            }
        }

        // Pagination güncelleme fonksiyonu (örnek: Routes)
        function updateRoutesPagination() {
            // const totalPages = Math.ceil(routesTotal / routesPageSize) || 1; // Bu satır kaldırıldı
            const totalPages = Math.ceil(routesTotal / routesPageSize) || 1; // Bu satır kaldırıldı
            const pagination = document.getElementById('routesPagination');
            const info = document.getElementById('routesPaginationInfo');
            if (!pagination || !info) return;
            let html = '';
            html += `<li class="page-item${routesPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('routes',${routesPage-1})">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${routesPage === i ? ' active' : ''}"><a class="page-link" href="#" onclick="changePage('routes',${i})">${i}</a></li>`;
            }
            html += `<li class="page-item${routesPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('routes',${routesPage+1})">Next</a></li>`;
            pagination.innerHTML = html;
            const start = (routesPage-1)*routesPageSize+1;
            const end = Math.min(routesPage*routesPageSize, routesTotal);
            info.textContent = `Showing ${start} to ${end} of ${routesTotal} entries`;
        }

        // Stops için parametreli yükleme
        async function loadStops() {
            try {
                const response = await fetch(`/AdminPanel/GetStops?page=${stopsPage}&pageSize=${stopsPageSize}`);
                if (response.ok) {
                    const data = await response.json();
                    updateStopsTable(data.items || data);
                    updateStopsPagination();
                } else {
                    showToast('Failed to load stops', 'error');
                }
            } catch (error) {
                console.error('Error loading stops:', error);
                showToast('Connection error while loading stops', 'error');
            }
        }

        // Stops için pagination güncelleme
        function updateStopsPagination() {

            // const totalPages = Math.ceil(stopsTotal / stopsPageSize) || 1; // Bu satır kaldırıldı
            const totalPages = Math.ceil(stopsTotal / stopsPageSize) || 1; // Bu satır kaldırıldı
            const pagination = document.getElementById('stopsPagination');
            const info = document.getElementById('stopsPaginationInfo');
            if (!pagination || !info) return;
            let html = '';
            html += `<li class="page-item${stopsPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('stops',${stopsPage-1})">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${stopsPage === i ? ' active' : ''}"><a class="page-link" href="#" onclick="changePage('stops',${i})">${i}</a></li>`;
            }
            html += `<li class="page-item${stopsPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('stops',${stopsPage+1})">Next</a></li>`;
            pagination.innerHTML = html;
            const start = (stopsPage-1)*stopsPageSize+1;
            const end = Math.min(stopsPage*stopsPageSize, stopsTotal);
            info.textContent = `Showing ${start} to ${end} of ${stopsTotal} entries`;
        }

        // Trips için parametreli yükleme
        async function loadTrips() {
            try {
                const response = await fetch(`/AdminPanel/GetTrips?page=${tripsPage}&pageSize=${tripsPageSize}`);
                if (response.ok) {
                    const data = await response.json();
                    updateTripsTable(data.items || data);
                    updateTripsPagination();
                } else {
                    showToast('Failed to load trips', 'error');
                }
            } catch (error) {
                console.error('Error loading trips:', error);
                showToast('Connection error while loading trips', 'error');
            }
        }

        // Trips için pagination güncelleme
        function updateTripsPagination() {
            // const totalPages = Math.ceil(tripsTotal / tripsPageSize) || 1; // Bu satır kaldırıldı
            const totalPages = Math.ceil(tripsTotal / tripsPageSize) || 1; // Bu satır kaldırıldı
            const pagination = document.getElementById('tripsPagination');
            const info = document.getElementById('tripsPaginationInfo');
            if (!pagination || !info) return;
            let html = '';
            html += `<li class="page-item${tripsPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('trips',${tripsPage-1})">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${tripsPage === i ? ' active' : ''}"><a class="page-link" href="#" onclick="changePage('trips',${i})">${i}</a></li>`;
            }
            html += `<li class="page-item${tripsPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('trips',${tripsPage+1})">Next</a></li>`;
            pagination.innerHTML = html;
            const start = (tripsPage-1)*tripsPageSize+1;
            const end = Math.min(tripsPage*tripsPageSize, tripsTotal);
            info.textContent = `Showing ${start} to ${end} of ${tripsTotal} entries`;
        }

        // Route Stops için parametreli yükleme
        async function loadRouteStops() {
            try {
                const response = await fetch(`/AdminPanel/GetAllRouteStops?page=${routeStopsPage}&pageSize=${routeStopsPageSize}`);
                if (response.ok) {
                    const data = await response.json();
                    updateRouteStopsTable(data.items || data);
                    updateRouteStopsPagination();
                } else {
                    showToast('Failed to load route stops', 'error');
                }
            } catch (error) {
                console.error('Error loading route stops:', error);
                showToast('Connection error while loading route stops', 'error');
            }
        }

        function updateRouteStopsTable(routeStops) {
            const tbody = document.getElementById('routeStopsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            routeStops.forEach(rs => {
                const row = `
                    <tr>
                        <td>${rs.id}</td>
                        <td><span class="badge bg-primary">${rs.routeName || '-'}</span></td>
                        <td><i class="fas fa-map-pin text-danger"></i> ${rs.stopName || '-'}</td>
                        <td><span class="badge bg-secondary">${rs.order || '-'}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="editRouteStop(${rs.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteRouteStop(${rs.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateRouteStopsPagination() {
            const totalPages = Math.ceil(routeStopsTotal / routeStopsPageSize) || 1;
            const pagination = document.getElementById('routeStopsPagination');
            const info = document.getElementById('routeStopsPaginationInfo');
            if (!pagination || !info) return;
            let html = '';
            html += `<li class="page-item${routeStopsPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('routeStops',${routeStopsPage-1})">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${routeStopsPage === i ? ' active' : ''}"><a class="page-link" href="#" onclick="changePage('routeStops',${i})">${i}</a></li>`;
            }
            html += `<li class="page-item${routeStopsPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="changePage('routeStops',${routeStopsPage+1})">Next</a></li>`;
            pagination.innerHTML = html;
            const start = (routeStopsPage-1)*routeStopsPageSize+1;
            const end = Math.min(routeStopsPage*routeStopsPageSize, routeStopsTotal);
            info.textContent = `Showing ${start} to ${end} of ${routeStopsTotal} entries`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            
            // Theme ayarlarını yükle
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.remove('light', 'dark');
            document.body.classList.add(savedTheme);
            
            // Settings modal'daki theme radio button'larını güncelle
            if (savedTheme === 'dark') {
                document.getElementById('darkTheme').checked = true;
            } else {
                document.getElementById('lightTheme').checked = true;
            }
            
            // Auto refresh ayarlarını yükle
            const autoRefresh = localStorage.getItem('autoRefresh') === 'true';
            if (autoRefresh) {
                document.getElementById('autoRefresh').checked = true;
            }
        });
        
        // Load initial data from backend APIs
        async function loadInitialData() {
            console.log('Loading initial data from backend...');
            try {
                // Load all data in parallel
                await Promise.all([
                    loadRoutes(),
                    loadStops(),
                    loadTrips(),
                    loadRouteStops(), // RouteStops'u da ekledim
                    loadStats()
                ]);
                console.log('Initial data loaded successfully');
            } catch (error) {
                console.error('Error loading initial data:', error);
                showToast('Failed to load some data. Please refresh the page.', 'error');
            }
        }

        // Dynamic stop row for CreateRouteWithStops
        function addStopRow() {
            const container = document.getElementById('routeStopsRepeater');
            if (!container) return;
            const id = 'stop-' + Date.now();
            const html = `
                <div class="stop-row border rounded p-2" id="${id}">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Stop Name</label>
                            <input type="text" class="form-control stop-name" placeholder="Eg. Central Station" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Latitude</label>
                            <input type="number" step="0.000001" class="form-control stop-lat" placeholder="40.123456" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Longitude</label>
                            <input type="number" step="0.000001" class="form-control stop-lon" placeholder="29.123456" required>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Order</label>
                            <input type="number" min="1" class="form-control stop-order" value="1">
                        </div>
                        <div class="col-md-1 d-grid">
                            <button type="button" class="btn btn-outline-danger" onclick="document.getElementById('${id}').remove()"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }
        
        // Load basic stats
        async function loadStats() {
            try {
                // Routes count
                const routesResponse = await fetch('/AdminPanel/GetRoutesCount');
                if (routesResponse.ok) {
                    const routesCount = await routesResponse.json();
                    document.getElementById('totalRoutes').textContent = routesCount || 0;
                    routesTotal = routesCount || 0;
                    updateRoutesPagination();
                }
                
                // Stops count  
                const stopsResponse = await fetch('/AdminPanel/GetStopsCount');
                if (stopsResponse.ok) {
                    const stops = await stopsResponse.json();
                    document.getElementById('totalStops').textContent = stops || 0;
                    stopsTotal = stops || 0;
                    updateStopsPagination();
                }
                
                // Trips count
                const tripsResponse = await fetch('/AdminPanel/GetTripsCount');
                if (tripsResponse.ok) {
                    const trips = await tripsResponse.json();
                    document.getElementById('totalTrips').textContent = trips || 0;
                    tripsTotal = trips || 0;
                    updateTripsPagination();
                }

                // RouteStops count
                const routeStopsResponse = await fetch('/AdminPanel/GetRouteStopsCount');
                if (routeStopsResponse.ok) {
                    const routeStops = await routeStopsResponse.json();
                    document.getElementById('totalConnections').textContent = routeStops || 0;
                    routeStopsTotal = routeStops || 0;
                    updateRouteStopsPagination();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Refresh all data
        function refreshAllData() {
            showToast('Refreshing data...', 'info');
            // API calls to refresh all data
            setTimeout(() => {
                showToast('Data refreshed successfully!', 'success');
            }, 1000);
        }
        
        // Route Functions
        async function saveRoute() {
            const routeName = document.getElementById('routeName').value.trim();
            const routeDescription = document.getElementById('routeDescription').value.trim();
            const startLocation = document.getElementById('startLocation').value.trim();
            const endLocation = document.getElementById('endLocation').value.trim();
            if (!routeName || !startLocation || !endLocation) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            // Stops builder
            const stopRows = document.querySelectorAll('#routeStopsRepeater .stop-row');
            const stops = [];
            stopRows.forEach((row, idx) => {
                const stopName = row.querySelector('.stop-name').value.trim();
                const lat = parseFloat(row.querySelector('.stop-lat').value);
                const lon = parseFloat(row.querySelector('.stop-lon').value);
                const order = parseInt(row.querySelector('.stop-order').value || (idx + 1));
                if (!stopName || isNaN(lat) || isNaN(lon)) return; // skip invalid rows
                stops.push({ 
                    "stopName": stopName, 
                    "stopId": 0, 
                    "latitude": lat, 
                    "longitude": lon, 
                    "order": order 
                });
            });

            const tokenStr = localStorage.getItem('token');
            const token = tokenStr ? JSON.parse(tokenStr) : {};
            const createdById = parseInt(token.userId || token.id || 1) || 1; // 0 yerine 1 default

            try {
                showToast('Creating route with stops...', 'info');
                
                // Swagger şemasına tam uyumlu payload
                const payload = {
                    "routeName": routeName,
                    "description": routeDescription || "string", // Swagger'da string default
                    "startLocation": startLocation,
                    "endLocation": endLocation,
                    "createdById": createdById,
                    "stops": stops
                };
                
                console.log('Sending payload:', JSON.stringify(payload, null, 2));
                
                const res = await fetch(`https://localhost:7007/api/routes/CreateRouteWithStops`, {
                    method: 'POST',
                    headers: 
                        {   'Content-Type': 'application/json',
                            'Authorization' : `Bearer ${token}`},
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || 'CreateRouteWithStops failed');
                }
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addRouteModal')).hide();
                // Clear form
                document.getElementById('addRouteForm').reset();
                document.getElementById('routeStopsRepeater').innerHTML = '';
                addStopRow();
                // Refresh routes data
                loadRoutes();
                showToast('Route created successfully!', 'success');
            } catch (error) {
                console.error('Error creating route with stops:', error);
                showToast('Error while creating route with stops', 'error');
            }
        }
        
        // Load routes from backend
        async function loadRoutes() {
            try {
                const routesResponse = await fetch('/AdminPanel/GetRoutes');
                if (routesResponse.ok) {
                    const routes = await routesResponse.json();
                    updateRoutesTable(routes);
                }
            } catch (error) {
                console.error('Error loading routes:', error);
                showToast('Connection error while loading routes', 'error');
            }
        }
        
        // Update routes table with data
        function updateRoutesTable(routes) {
            const tbody = document.getElementById('routesTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            routes.forEach(route => {
                const row = `
                    <tr>
                        <td>${route.id}</td>
                        <td><span class="badge bg-primary">${route.name}</span></td>
                        <td>${route.description || '-'}</td>
                        <td>${route.startLocation || '-'}</td>
                        <td>${route.endLocation || '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="editRoute(${route.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                  <button class="btn btn-outline-primary" onclick="showRouteStops(${route.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteRoute(${route.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function editRoute(id) {
            // Store the ID globally as backup
            currentEditingRouteId = id;
            
            try {
                showToast('Loading route data...', 'info');
                
                // API call to get route data
                const response = await fetch(`https://localhost:7007/api/routes/id?id=${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });
                
                if (response.ok) {
                    const routeData = await response.json();
                    console.log('DEBUG editRoute - loaded route data:', routeData);
                    
                    // Handle both array and object responses
                    const route = Array.isArray(routeData) ? routeData[0] : routeData;
                    console.log('DEBUG editRoute - processed route object:', route);
                    
                    if (!route) {
                        throw new Error('No route data found in response');
                    }
                    
                    // Populate update modal with existing data
                    document.getElementById('updateRouteId').value = route.id;
                    document.getElementById('updateRouteName').value = route.name || '';
                    document.getElementById('updateRouteDescription').value = route.description || '';
                    document.getElementById('updateStartLocation').value = route.startLocation || '';
                    document.getElementById('updateEndLocation').value = route.endLocation || '';
                    
                    // Show update modal
                    const modal = new bootstrap.Modal(document.getElementById('updateRouteModal'));
                    modal.show();
                } else {
                    throw new Error('Failed to load route data');
                }
            } catch (error) {
                console.error('Error loading route:', error);
                showToast('Error loading route data', 'error');
            }
        }

                async function deleteRoute(id) {
            if (!confirm('Are you sure you want to delete this route?')) return;

            try {
                showToast('Deleting route...', 'info');

                const tokenStr = localStorage.getItem('token');
                const tokenData = tokenStr ? JSON.parse(tokenStr) : null;
                const accessToken = tokenData?.accessToken || tokenData?.token?.accessToken;
                
                if (!accessToken) {
                    showToast('Authentication token not found!', 'error');
                    return;
                }

                const response = await fetch(`https://localhost:7007/api/routes/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete failed:', errorText);
                    showToast(`Failed to delete route: ${errorText}`, 'error');
                    return;
                }

                console.log(`Route ${id} deleted successfully`);
                showToast('Route deleted successfully!', 'success');
                loadRoutes(); // Refresh list
            } catch (error) {
                console.error('Error deleting route:', error);
                showToast('Connection error while deleting route', 'error');
            }
        }


        async function showRouteStops(routeId) {
            console.log('showRouteStops çağrıldı, routeId:', routeId);
            
            try {
                // Modal'ı doğrudan Bootstrap ile aç
                const modalElement = document.getElementById('routeStopsModal');
                if (!modalElement) {
                    console.error('Modal elementi bulunamadı!');
                    showToast('Modal elementi bulunamadı!', 'error');
                    return;
                }
                
                // Modal'ı aç
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                // Loading göster
                const modalBody = document.getElementById('routeStopsModalBody');
                if (modalBody) {
                    modalBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center py-4">
                                <div class="loading-spinner"></div>
                                <p class="mt-3 mb-0 text-muted">Route stops yükleniyor...</p>
                            </td>
                        </tr>
                    `;
                }
                
                // API'den veri çek
                const response = await fetch(`https://localhost:7007/api/routes/${routeId}/stops` , 
                {
                    headers:{
                        'X-Api-Key' : 'melihin-muhtesem-otesi-apisi',
                        'Authorization' : 'Bearer melihin-muhtesem-otesi-apisi'
                    }
                }
                );
                
                if (response.ok) {
                    const stops = await response.json();
                    if (modalBody) {
                        modalBody.innerHTML = ''; // Clear previous content
                        if (stops.length > 0) {
                            stops.forEach((stop, index) => {
                                const row = `
                                    <tr class="route-stop-row" data-stop-id="${stop.id}">
                                        <td>
                                            <span class="badge bg-primary rounded-pill">${index + 1}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                                <span class="fw-semibold">${stop.name || 'İsimsiz Durak'}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-location-dot text-success me-2"></i>
                                                <span>${stop.latitude}, ${stop.longitude}</span>
                                            </div>
                                        </td>
                                    </tr>`;
                                modalBody.innerHTML += row;
                            });
                        } else {
                            modalBody.innerHTML = `
                                <tr>
                                    <td colspan="3" class="text-center py-4">
                                        <div class="empty-state">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <h5 class="mb-2">Henüz durak bulunmuyor</h5>
                                            <p class="text-muted mb-0">Bu route için henüz durak eklenmemiş.</p>
                                        </div>
                                    </td>
                                </tr>`;
                        }
                    }
                } else {
                    if (modalBody) {
                        modalBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <div class="empty-state">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        <h5 class="mb-2 text-warning">Hata</h5>
                                        <p class="text-muted mb-0">Route durakları yüklenemedi.</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    showToast('Route durakları yüklenemedi.', 'error');
                }
            } catch (error) {
                console.error('Route stops yükleme hatası:', error);
                showToast('Route durakları yüklenirken bir hata oluştu.', 'error');
            }
        }
        
        // Stop Functions
        async function saveStop() {
            const stopName = document.getElementById('stopName').value;
            const stopLatitude = parseFloat(document.getElementById('stopLatitude').value);
            const stopLongitude = parseFloat(document.getElementById('stopLongitude').value);
            
            console.log('DEBUG saveStop - stopName:', stopName, 'lat:', stopLatitude, 'lng:', stopLongitude);
            
            if (!stopName || isNaN(stopLatitude) || isNaN(stopLongitude)) {
                showToast('Please fill in all required fields with valid values!', 'error');
                return;
            }
            
            try {
                showToast('Creating stop...', 'info');
                
                // Backend API'ye POST isteği gönder
                const response = await fetch('https://localhost:7007/api/stops/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    },
                    body: JSON.stringify({
                        Name: stopName,
                        Latitude: stopLatitude,
                        Longitude: stopLongitude
                    })
                });
                
                console.log('DEBUG saveStop - response status:', response.status, 'ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('DEBUG saveStop - result:', result);
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('addStopModal')).hide();
                    
                    // Clear form
                    document.getElementById('addStopForm').reset();
                    
                    // Show success message
                    showToast(`Stop "${result.name || result.Name || stopName}" created successfully!`, 'success');
                    
                    // Refresh stops table
                    await updateStopsTable();
                } else {
                    const errorText = await response.text();
                    console.error('DEBUG saveStop - error response:', errorText);
                    showToast(`Failed to create stop: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('DEBUG saveStop - catch error:', error);
                showToast('Connection error. Please try again.', 'error');
            }
        }
        
        
        
        // Update stops table with data
        function updateStopsTable(stops) {
            const tbody = document.getElementById('stopsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            stops.forEach(stop => {
                const row = `
                    <tr>
                        <td>${stop.id}</td>
                        <td><span class="badge bg-success">${stop.name}</span></td>
                        <td>${stop.latitude.toFixed(6)}</td>
                        <td>${stop.longitude.toFixed(6)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="editStop(${stop.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteStop(${stop.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function editStop(id) {
            console.log('DEBUG editStop called with id:', id, 'type:', typeof id);
            
            // Store the ID globally as backup
            currentEditingStopId = id;
            
            try {
                showToast('Loading stop data...', 'info');
                
                // API call to get stop data
                const response = await fetch(`https://localhost:7007/api/stops/${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });
                
                if (response.ok) {
                    const stopData = await response.json();
                    console.log('DEBUG editStop - loaded stop data:', stopData);
                    
                    // Handle both array and object responses
                    const stop = Array.isArray(stopData) ? stopData[0] : stopData;
                    console.log('DEBUG editStop - processed stop object:', stop);
                    
                    if (!stop) {
                        throw new Error('No stop data found in response');
                    }
                    
                    // Populate update modal with existing data
                    document.getElementById('updateStopId').value = stop.id;
                    document.getElementById('updateStopName').value = stop.name || '';
                    document.getElementById('updateStopLatitude').value = stop.latitude || '';
                    document.getElementById('updateStopLongitude').value = stop.longitude || '';
                    
                    console.log('DEBUG editStop - populated form fields:', {
                        id: document.getElementById('updateStopId').value,
                        name: document.getElementById('updateStopName').value,
                        lat: document.getElementById('updateStopLatitude').value,
                        lng: document.getElementById('updateStopLongitude').value
                    });
                    
                    // Show update modal
                    const modal = new bootstrap.Modal(document.getElementById('updateStopModal'));
                    modal.show();
                } else {
                    throw new Error('Failed to load stop data');
                }
            } catch (error) {
                console.error('Error loading stop:', error);
                showToast('Error loading stop data', 'error');
            }
        }
        
        async function deleteStop(id) {
            if (!confirm('Are you sure you want to delete this stop?')) return;

            try {
                showToast('Deleting stop...', 'info');

                const tokenStr = localStorage.getItem('token');
                const tokenData = tokenStr ? JSON.parse(tokenStr) : null;
                const accessToken = tokenData?.accessToken || tokenData?.token?.accessToken;
                
                if (!accessToken) {
                    showToast('Authentication token not found!', 'error');
                    return;
                }

                const response = await fetch(`https://localhost:7007/api/stops/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete failed:', errorText);
                    showToast(`Failed to delete stop: ${errorText}`, 'error');
                    return;
                }

                console.log(`Stop ${id} deleted successfully`);
                showToast('Stop deleted successfully!', 'success');
                loadStops(); // Refresh list
            } catch (error) {
                console.error('Error deleting stop:', error);
                showToast('Connection error while deleting stop', 'error');
            }
        }
        
        // Trip Functions
        
        // Load trips from backend
        async function loadTrips() {
            try {
                const tripsResponse = await fetch('/AdminPanel/GetTrips');
                if (tripsResponse.ok) {
                    const trips = await tripsResponse.json();
                    updateTripsTable(trips);
                }
            } catch (error) {
                console.error('Error loading trips:', error);
                showToast('Connection error while loading trips', 'error');
            }
        }
        
        // Update trips table with data
        function updateTripsTable(trips) {
            const tbody = document.getElementById('tripsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            trips.forEach(trip => {
                const row = `
                    <tr>
                        <td>${trip.id}</td>
                        <td><span class="badge bg-warning">${trip.routeId}</span></td>
                        <td>${trip.startTime}</td>
                        <td>${trip.endTime}</td>
                        <td><span class="badge bg-info">${trip.dayType}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="editTrip(${trip.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteTrip(${trip.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function saveTrip() {
            const tripRoute = parseInt(document.getElementById('tripRoute').value);
            let startTime = document.getElementById('startTime').value;
            let endTime = document.getElementById('endTime').value;
            const dayType = document.getElementById('dayType').value;
            if (!tripRoute || !startTime || !endTime || !dayType) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            // Ensure HH:mm:ss format
            if (startTime.length === 5) startTime += ':00';
            if (endTime.length === 5) endTime += ':00';
            try {
                const res = await fetch(`https://localhost:7007/api/trips`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' , 'X-Api-Key' : 'melihin-muhtesem-otesi-apisi'},
                    body: JSON.stringify({
                        routeId: tripRoute,
                        startTime: startTime,
                        endTime: endTime,
                        dayType: dayType
                    })
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || 'Trip create failed');
                }
                bootstrap.Modal.getInstance(document.getElementById('addTripModal')).hide();
                document.getElementById('addTripForm').reset();
                showToast('Trip added successfully!', 'success');
                loadTrips();
            } catch (e) {
                console.error(e);
                showToast('Error while creating trip', 'error');
            }
        }

        // Load dropdowns when modals are opened
        document.addEventListener('DOMContentLoaded', function() {
            // Add Trip modal listeners
            const addTripModal = document.getElementById('addTripModal');
            if (addTripModal) {
                addTripModal.addEventListener('shown.bs.modal', function () {
                    loadRoutesForDropdown('tripRoute');
                });
            }

            // Add Route Stop modal listeners
            const addRouteStopModal = document.getElementById('addRouteStopModal');
            if (addRouteStopModal) {
                addRouteStopModal.addEventListener('shown.bs.modal', function () {
                    loadRoutesForDropdown('routeStopRoute');
                    loadStopsForDropdown('routeStopStop');
                });
            }
        });
        
        async function editTrip(id) {
            // Store the ID globally as backup
            currentEditingTripId = id;
            
            try {
                showToast('Loading trip data...', 'info');
                
                // Load routes for dropdown first
                await loadRoutesForDropdown('updateTripRoute');
                
                // API call to get trip data
                const response = await fetch(`https://localhost:7007/api/trips/${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });
                
                if (response.ok) {
                    const tripData = await response.json();
                    console.log('DEBUG editTrip - loaded trip data:', tripData);
                    
                    // Handle both array and object responses
                    const trip = Array.isArray(tripData) ? tripData[0] : tripData;
                    console.log('DEBUG editTrip - processed trip object:', trip);
                    
                    if (!trip) {
                        throw new Error('No trip data found in response');
                    }
                    
                    // Populate update modal with existing data
                    document.getElementById('updateTripId').value = trip.id;
                    document.getElementById('updateTripRoute').value = trip.routeId || '';
                    
                    // Format time values (remove seconds if present)
                    const startTime = trip.startTime ? trip.startTime.substring(0, 5) : '';
                    const endTime = trip.endTime ? trip.endTime.substring(0, 5) : '';
                    
                    document.getElementById('updateStartTime').value = startTime;
                    document.getElementById('updateEndTime').value = endTime;
                    document.getElementById('updateDayType').value = trip.dayType || '';
                    
                    // Show update modal
                    const modal = new bootstrap.Modal(document.getElementById('updateTripModal'));
                    modal.show();
                } else {
                    throw new Error('Failed to load trip data');
                }
            } catch (error) {
                console.error('Error loading trip:', error);
                showToast('Error loading trip data', 'error');
            }
        }
        
        async function deleteTrip(id) {
            if (!confirm('Are you sure you want to delete this trip?')) return;

            try {
                showToast('Deleting trip...', 'info');

                const tokenStr = localStorage.getItem('token');
                const tokenData = tokenStr ? JSON.parse(tokenStr) : null;
                const accessToken = tokenData?.accessToken || tokenData?.token?.accessToken;
                
                if (!accessToken) {
                    showToast('Authentication token not found!', 'error');
                    return;
                }

                const response = await fetch(`https://localhost:7007/api/trips/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete failed:', errorText);
                    showToast(`Failed to delete trip: ${errorText}`, 'error');
                    return;
                }

                console.log(`Trip ${id} deleted successfully`);
                showToast('Trip deleted successfully!', 'success');
                loadTrips(); // Refresh list
            } catch (error) {
                console.error('Error deleting trip:', error);
                showToast('Connection error while deleting trip', 'error');
            }
        }
        
        // Route Stop Functions
        async function saveRouteStop() {
            const routeStopRoute = parseInt(document.getElementById('routeStopRoute').value);
            const routeStopStop = parseInt(document.getElementById('routeStopStop').value);
            const stopOrder = parseInt(document.getElementById('stopOrder').value);
            if (!routeStopRoute || !routeStopStop || !stopOrder) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            try {
                const res = await fetch(`/AdminPanel/CreateRouteStop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ routeId: routeStopRoute, stopId: routeStopStop, order: stopOrder })
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || 'RouteStop create failed');
                }
                bootstrap.Modal.getInstance(document.getElementById('addRouteStopModal')).hide();
                document.getElementById('addRouteStopForm').reset();
                showToast('Route stop connection added successfully!', 'success');
                loadRouteStops();
            } catch (e) {
                console.error(e);
                showToast('Error while creating route stop', 'error');
            }
        }
        
        async function editRouteStop(id) {
            // Store the ID globally as backup
            currentEditingRouteStopId = id;
            
            try {
                showToast('Loading route stop data...', 'info');
                
                // Load routes and stops for dropdowns first
                await Promise.all([
                    loadRoutesForDropdown('updateRouteStopRoute'),
                    loadStopsForDropdown('updateRouteStopStop')
                ]);
                
                // API call to get route stop data
                const response = await fetch(`https://localhost:7007/api/routestop/id?id=${id}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });
                
                if (response.ok) {
                    const routeStopData = await response.json();
                    console.log('DEBUG editRouteStop - loaded routeStop data:', routeStopData);
                    
                    // Handle both array and object responses
                    const routeStop = Array.isArray(routeStopData) ? routeStopData[0] : routeStopData;
                    console.log('DEBUG editRouteStop - processed routeStop object:', routeStop);
                    
                    if (!routeStop) {
                        throw new Error('No routeStop data found in response');
                    }
                    
                    // Populate update modal with existing data
                    document.getElementById('updateRouteStopId').value = routeStop.id;
                    document.getElementById('updateRouteStopRoute').value = routeStop.routeId || '';
                    document.getElementById('updateRouteStopStop').value = routeStop.stopId || '';
                    document.getElementById('updateStopOrder').value = routeStop.order || '';
                    
                    // Show update modal
                    const modal = new bootstrap.Modal(document.getElementById('updateRouteStopModal'));
                    modal.show();
                } else {
                    throw new Error('Failed to load route stop data');
                }
            } catch (error) {
                console.error('Error loading route stop:', error);
                showToast('Error loading route stop data', 'error');
            }
        }
        
        async function deleteRouteStop(id) {
            if (!confirm('Are you sure you want to delete this route stop connection?')) return;

            try {
                showToast('Deleting route stop...', 'info');

                const tokenStr = localStorage.getItem('token');
                const tokenData = tokenStr ? JSON.parse(tokenStr) : null;
                const accessToken = tokenData?.accessToken || tokenData?.token?.accessToken;
                
                if (!accessToken) {
                    showToast('Authentication token not found!', 'error');
                    return;
                }

                const response = await fetch(`https://localhost:7007/api/routestop/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete failed:', errorText);
                    showToast(`Failed to delete route stop: ${errorText}`, 'error');
                    return;
                }

                console.log(`Route stop ${id} deleted successfully`);
                showToast('Route stop connection deleted successfully!', 'success');
                loadRouteStops(); // Refresh list
            } catch (error) {
                console.error('Error deleting route stop:', error);
                showToast('Connection error while deleting route stop', 'error');
            }
        }
        
        // Update Functions
        async function updateRoute() {
            const routeId = document.getElementById('updateRouteId').value || currentEditingRouteId;
            const routeName = document.getElementById('updateRouteName').value.trim();
            const routeDescription = document.getElementById('updateRouteDescription').value.trim();
            const startLocation = document.getElementById('updateStartLocation').value.trim();
            const endLocation = document.getElementById('updateEndLocation').value.trim();
            
            if (!routeId) {
                showToast('Route ID is missing!', 'error');
                return;
            }
            
            if (!routeName || !startLocation || !endLocation) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            
            try {
                showToast('Updating route...', 'info');
                
                const response = await fetch(`https://localhost:7007/api/routes/${routeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    },
                    body: JSON.stringify({
                        id: parseInt(routeId),
                        name: routeName,
                        description: routeDescription || '',
                        startLocation: startLocation,
                        endLocation: endLocation
                    })
                });
                
                if (response.ok) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('updateRouteModal')).hide();
                    
                    // Clear form
                    document.getElementById('updateRouteForm').reset();
                    
                    showToast('Route updated successfully!', 'success');
                    loadRoutes(); // Refresh the routes table
                } else {
                    throw new Error('Failed to update route');
                }
            } catch (error) {
                console.error('Error updating route:', error);
                showToast('Error updating route', 'error');
            }
        }
        
        // Global variables to store current editing IDs
        let currentEditingRouteId = null;
        let currentEditingStopId = null;
        let currentEditingTripId = null;
        let currentEditingRouteStopId = null;

        async function updateStop() {
            // Use global variable as fallback if form field is empty
            const stopId = document.getElementById('updateStopId').value || currentEditingStopId;
            const stopName = document.getElementById('updateStopName').value.trim();
            const stopLatitude = parseFloat(document.getElementById('updateStopLatitude').value);
            const stopLongitude = parseFloat(document.getElementById('updateStopLongitude').value);
            
            console.log('DEBUG updateStop - stopId:', stopId, 'currentEditingStopId:', currentEditingStopId, 'stopName:', stopName, 'lat:', stopLatitude, 'lng:', stopLongitude);
            console.log('DEBUG updateStop - form field value:', document.getElementById('updateStopId').value);
            console.log('DEBUG updateStop - form field element:', document.getElementById('updateStopId'));
            
            if (!stopId) {
                showToast('Stop ID is missing!', 'error');
                console.error('DEBUG updateStop - Both stopId sources are empty');
                return;
            }
            
            if (!stopName || isNaN(stopLatitude) || isNaN(stopLongitude)) {
                showToast('Please fill in all required fields with valid values!', 'error');
                return;
            }
            
            try {
                showToast('Updating stop...', 'info');
                
                const response = await fetch(`https://localhost:7007/api/stops/${stopId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    },
                    body: JSON.stringify({
                        id: parseInt(stopId),
                        name: stopName,
                        latitude: stopLatitude,
                        longitude: stopLongitude
                    })
                });
                
                if (response.ok) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('updateStopModal')).hide();
                    
                    // Clear form
                    document.getElementById('updateStopForm').reset();
                    
                    showToast('Stop updated successfully!', 'success');
                    loadStops(); // Refresh the stops table
                } else {
                    throw new Error('Failed to update stop');
                }
            } catch (error) {
                console.error('Error updating stop:', error);
                showToast('Error updating stop', 'error');
            }
        }
        
        async function updateTrip() {
            const tripId = document.getElementById('updateTripId').value || currentEditingTripId;
            const tripRoute = parseInt(document.getElementById('updateTripRoute').value);
            let startTime = document.getElementById('updateStartTime').value;
            let endTime = document.getElementById('updateEndTime').value;
            const dayType = document.getElementById('updateDayType').value;
            
            if (!tripId) {
                showToast('Trip ID is missing!', 'error');
                return;
            }
            
            if (!tripRoute || !startTime || !endTime || !dayType) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            
            // Ensure HH:mm:ss format
            if (startTime.length === 5) startTime += ':00';
            if (endTime.length === 5) endTime += ':00';
            
            try {
                showToast('Updating trip...', 'info');
                
                const response = await fetch(`https://localhost:7007/api/trips/${tripId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    },
                    body: JSON.stringify({
                        id: parseInt(tripId),
                        routeId: tripRoute,
                        startTime: startTime,
                        endTime: endTime,
                        dayType: dayType
                    })
                });
                
                if (response.ok) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('updateTripModal')).hide();
                    
                    // Clear form
                    document.getElementById('updateTripForm').reset();
                    
                    showToast('Trip updated successfully!', 'success');
                    loadTrips(); // Refresh the trips table
                } else {
                    throw new Error('Failed to update trip');
                }
            } catch (error) {
                console.error('Error updating trip:', error);
                showToast('Error updating trip', 'error');
            }
        }
        
        async function updateRouteStop() {
            const routeStopId = document.getElementById('updateRouteStopId').value || currentEditingRouteStopId;
            const routeStopRoute = parseInt(document.getElementById('updateRouteStopRoute').value);
            const routeStopStop = parseInt(document.getElementById('updateRouteStopStop').value);
            const stopOrder = parseInt(document.getElementById('updateStopOrder').value);
            
            if (!routeStopId) {
                showToast('Route Stop ID is missing!', 'error');
                return;
            }
            
            if (!routeStopRoute || !routeStopStop || !stopOrder) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            
            try {
                showToast('Updating route stop...', 'info');
                
                const response = await fetch(`https://localhost:7007/api/routestop/${routeStopId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'melihin-muhtesem-otesi-apisi'
                    },
                    body: JSON.stringify({
                        id: parseInt(routeStopId),
                        routeId: routeStopRoute,
                        stopId: routeStopStop,
                        order: stopOrder
                    })
                });
                
                if (response.ok) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('updateRouteStopModal')).hide();
                    
                    // Clear form
                    document.getElementById('updateRouteStopForm').reset();
                    
                    showToast('Route stop updated successfully!', 'success');
                    loadRouteStops(); // Refresh the route stops table
                } else {
                    throw new Error('Failed to update route stop');
                }
            } catch (error) {
                console.error('Error updating route stop:', error);
                showToast('Error updating route stop', 'error');
            }
        }
        
        // Helper Functions for Dropdowns
        async function loadRoutesForDropdown(selectId) {
            try {
                const response = await fetch('/AdminPanel/GetRoutes');
                if (response.ok) {
                    const routes = await response.json();
                    const select = document.getElementById(selectId);
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">Select a route</option>';
                    
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.id;
                        option.textContent = route.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading routes for dropdown:', error);
            }
        }
        
        async function loadStopsForDropdown(selectId) {
            try {
                const response = await fetch('/AdminPanel/GetStops');
                if (response.ok) {
                    const stops = await response.json();
                    const select = document.getElementById(selectId);
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">Select a stop</option>';
                    
                    stops.forEach(stop => {
                        const option = document.createElement('option');
                        option.value = stop.id;
                        option.textContent = stop.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading stops for dropdown:', error);
            }
        }

        // Settings Functions
        function saveSettings() {
            const theme = document.querySelector('input[name="theme"]:checked')?.value;
            const autoRefresh = document.getElementById('autoRefresh').checked;
            
            // Save settings to localStorage
            if (theme && window.setTheme) {
                window.setTheme(theme, true); // Animasyonlu tema geçişi
            }
            localStorage.setItem('autoRefresh', autoRefresh);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            
            showToast('Settings saved successfully!', 'success');
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            let bgClass = 'bg-primary';
            let icon = 'fas fa-info-circle';
            
            switch(type) {
                case 'success':
                    bgClass = 'bg-success';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgClass = 'bg-danger';
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    bgClass = 'bg-warning';
                    icon = 'fas fa-exclamation-triangle';
                    break;
            }
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="${icon}"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }
        
        // RBAC Menu Control - Backend'den gerçek izinleri çek ve uygula
        async function initializeRBACMenus(tokenData) {
            try {
                console.log('=== RBAC MENU DEBUG START ===');
                console.log('Initializing RBAC menus for user:', tokenData);
                
                const userRole = tokenData.role;
                const userId = tokenData.userId || tokenData.id;
                
                console.log('User Role:', userRole, 'User ID:', userId);
                
                // Backend'den kullanıcının menü izinlerini al
                const menuPermissions = await fetchUserMenuPermissions(userId, userRole);
                console.log('Fetched menu permissions:', menuPermissions);

                if (!menuPermissions || menuPermissions.length === 0) {
                    console.warn('No menu permissions returned from backend');
                }
                
                // Menü ID'leri ve Tab ID'leri eşleştirmesi
                const menuTabMapping = {
                    1: 'dashboard',         // Dashboard (sayfa, tab değil)
                    3: 'routes-tab',        // Routes
                    4: 'stops-tab',         // Stops  
                    5: 'trips-tab',         // Trips
                    11: 'routestops-tab'    // Route Stops
                };
                
                // İzin verilen menü ID'lerini al (CanRead = true olanlar)
                const allowedMenuIds = menuPermissions
                    .filter(permission => permission.canRead === true)
                    .map(permission => permission.menuId)
                    .filter(id => id !== undefined && id !== 0);
                    
                console.log('Allowed menu IDs:', allowedMenuIds);
                
                // Tüm tab başlıklarını önce gizle (içerikleri Bootstrap yönetecek)
                Object.entries(menuTabMapping).forEach(([menuId, tabId]) => {
                    if (tabId !== 'dashboard') { // Dashboard tab değil, sayfa
                        const tab = document.getElementById(tabId);
                        if (tab) {
                            const li = tab.closest('li');
                            if (li) li.style.display = 'none';
                        }
                    }
                });
                
                // İzin verilen menüleri göster (yalnızca tab başlığını göster)
                Object.entries(menuTabMapping).forEach(([menuId, tabId]) => {
                    if (tabId === 'dashboard') return;
                    const tab = document.getElementById(tabId);
                    if (!tab) return;
                    const li = tab.closest('li');
                    if (allowedMenuIds.includes(parseInt(menuId))) {
                        if (li) li.style.display = 'block';
                        console.log(`Menu ${menuId} (${tabId}) - ALLOWED`);
                    } else {
                        if (li) li.style.display = 'none';
                        console.log(`Menu ${menuId} (${tabId}) - DENIED`);
                    }
                });
                
                // İlk görünür tab'ı aktif yap
                const visibleTabs = Object.values(menuTabMapping)
                    .filter(tabId => tabId !== 'dashboard')
                    .map(tabId => document.getElementById(tabId))
                    .filter(tab => tab && tab.style.display !== 'none');
                    
                if (visibleTabs.length > 0) {
                    // Mevcut aktif tab/pane sınıflarını temizle
                    document.querySelectorAll('#adminTabs .nav-link').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active', 'show'));

                    // Bootstrap Tab API ile ilk görünür tab'ı aktif et
                    try {
                        const firstTabEl = visibleTabs[0];
                        const tabInstance = bootstrap.Tab.getOrCreateInstance(firstTabEl);
                        tabInstance.show();
                        console.log('Activated first visible tab via Bootstrap:', firstTabEl.id);
                    } catch (e) {
                        console.warn('Bootstrap.Tab activation failed, falling back:', e);
                        const targetId = visibleTabs[0].getAttribute('data-bs-target');
                        if (targetId) {
                            const targetPane = document.querySelector(targetId);
                            if (targetPane) targetPane.classList.add('active', 'show');
                            visibleTabs[0].classList.add('active');
                        }
                    }
                }
                
                console.log('=== RBAC MENU DEBUG END ===');
                
            } catch (error) {
                console.error('=== RBAC MENU ERROR ===');
                console.error('Error initializing RBAC menus:', error);
                hideAllMenus();
            }
        }
        
        // Tüm menüleri gizle (güvenlik fallback)
        function hideAllMenus() {
            const menuTabs = ['routes-tab', 'stops-tab', 'trips-tab', 'routestops-tab'];
            const menuContents = ['routes', 'stops', 'trips', 'routestops'];
            
            menuTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) tab.style.display = 'none';
            });
            
            menuContents.forEach(contentId => {
                const content = document.getElementById(contentId);
                if (content) content.style.display = 'none';
            });
            
            console.log('All menus hidden for security');
        }
        
        // Backend'den kullanıcının menü izinlerini al
        async function fetchUserMenuPermissions(userId, roleId) {
            try {
                // RoleMenuPermission endpoint'ini kullan (direkt backend)
                console.log('Fetching permissions from backend for roleId:', roleId);
                const backendUrl = 'https://localhost:7007'; // Direkt backend
                const response = await fetch(`${backendUrl}/api/RoleMenuPermission/GetPermissionByRoleId?roleId=${roleId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': '@ViewBag.ApiKey'
                        // JWT token geçici olarak kaldırıldı, CORS testi için
                    },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const permissions = await response.json();
                    console.log('Raw permissions from backend:', permissions);
                    
                    // Backend'den gelen format: [{ roleId, menuId, canRead, canCreate, canUpdate, canDelete, menuName, menuUrl, roleName }]
                    // Frontend'de kullanılabilir format'a çevir
                    const formattedPermissions = permissions.map(p => ({
                        roleId: p.roleId,
                        menuId: p.menuId,
                        canRead: p.canRead,
                        canCreate: p.canCreate,
                        canUpdate: p.canUpdate,
                        canDelete: p.canDelete,
                        menuName: p.menuName,
                        menuUrl: p.menuUrl,
                        roleName: p.roleName
                    }));
                    
                    console.log('Formatted permissions:', formattedPermissions);
                    return formattedPermissions;
                } else {
                    console.error('Failed to fetch menu permissions, status:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching menu permissions:', error);
                return [];
            }
        }
        
        // Tab change handler
        document.querySelectorAll('#adminTabs button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (e) {
                const targetTab = e.target.getAttribute('data-bs-target');
                console.log('Switched to tab:', targetTab);
                // Load specific data for the tab if needed
            });
        });
        
    </script>
    
    <!-- AdminPanel özel JavaScript dosyası -->
    <script src="~/js/adminpanelscript.js" asp-append-version="true"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Admin Panel Harita Fonksiyonları -->
    <script>
        let adminMap = null;
        let adminMetroStationsLayer = null;
        let adminTramStationsLayer = null;

        // Admin panel haritasını başlat
        function initializeAdminMap() {
            if (adminMap) {
                adminMap.remove();
            }
            
            // İstanbul koordinatları
            adminMap = L.map('adminMap').setView([41.0082, 28.9784], 11);
            
            // OpenStreetMap tile layer ekle
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(adminMap);
            
            // Metro ve tramvay istasyonlarını yükle
            setTimeout(() => {
                loadAdminMetroStations();
                loadAdminTramStations();
            }, 500);
            
            // Checkbox event listeners
            document.getElementById('adminShowMetroStations').addEventListener('change', toggleAdminMetroStations);
            document.getElementById('adminShowTramStations').addEventListener('change', toggleAdminTramStations);
        }

        // Admin panel metro istasyonlarını yükle
        async function loadAdminMetroStations() {
            try {
                adminMetroStationsLayer = L.layerGroup().addTo(adminMap);
                
                // Tüm metro hatlarını yükle
                const metroLines = [
                    'M1A_istasyonlari', 'M1B_istasyonlari', 'M2_istasyonlari', 'M3_istasyonlari',
                    'M4_istasyonlari', 'M5_istasyonlari', 'M6_istasyonlari', 'M7_istasyonlari',
                    'M8_istasyonlari', 'M9_istasyonlari', 'M10_istasyonlari', 'M11_istasyonlari', 'M12_istasyonlari'
                ];
                
                for (const line of metroLines) {
                    try {
                        console.log(`Admin Metro hattı yükleniyor: ${line}`);
                        const response = await fetch(`/geojson/metro_hatlari/${line}.geojson`);
                        console.log(`Admin Response status for ${line}:`, response.status);
                        if (response.ok) {
                            const geoJsonData = await response.json();
                            console.log(`Admin GeoJSON data loaded for ${line}:`, geoJsonData.features.length, 'features');
                            
                            L.geoJSON(geoJsonData, {
                                pointToLayer: function(feature, latlng) {
                                    return L.circleMarker(latlng, {
                                        radius: 8,
                                        fillColor: '#007bff',
                                        color: '#0056b3',
                                        weight: 2,
                                        opacity: 1,
                                        fillOpacity: 0.8
                                    });
                                },
                                onEachFeature: function(feature, layer) {
                                    if (feature.properties && feature.properties.ISTASYON) {
                                        layer.bindPopup(`
                                            <div class="popup-content">
                                                <h6><i class="fas fa-train text-primary"></i> ${feature.properties.ISTASYON}</h6>
                                                <p class="mb-1"><strong>Hat:</strong> ${feature.properties.PROJE_ADI || 'Bilinmiyor'}</p>
                                                <p class="mb-1"><strong>Tür:</strong> ${feature.properties.HAT_TURU}</p>
                                                <p class="mb-0"><strong>Müdürlük:</strong> ${feature.properties.MUDURLUK || 'Bilinmiyor'}</p>
                                            </div>
                                        `);
                                    }
                                }
                            }).addTo(adminMetroStationsLayer);
                        } else {
                            console.error(`Admin HTTP Error ${response.status} for ${line}:`, response.statusText);
                        }
                    } catch (error) {
                        console.error(`Admin Metro hattı yüklenemedi: ${line}`, error);
                    }
                }
            } catch (error) {
                console.error('Admin metro istasyonları yüklenirken hata:', error);
            }
        }

        // Admin panel tramvay istasyonlarını yükle
        async function loadAdminTramStations() {
            try {
                adminTramStationsLayer = L.layerGroup().addTo(adminMap);
                
                // Tüm tramvay hatlarını yükle
                const tramLines = ['T1_istasyonlari', 'T3_istasyonlari', 'T4_istasyonlari', 'T5_istasyonlari'];
                
                for (const line of tramLines) {
                    try {
                        console.log(`Admin Tramvay hattı yükleniyor: ${line}`);
                        const response = await fetch(`/geojson/tramvay_hatlari/${line}.geojson`);
                        console.log(`Admin Response status for ${line}:`, response.status);
                        if (response.ok) {
                            const geoJsonData = await response.json();
                            console.log(`Admin GeoJSON data loaded for ${line}:`, geoJsonData.features.length, 'features');
                            
                            L.geoJSON(geoJsonData, {
                                pointToLayer: function(feature, latlng) {
                                    return L.circleMarker(latlng, {
                                        radius: 8,
                                        fillColor: '#17a2b8',
                                        color: '#138496',
                                        weight: 2,
                                        opacity: 1,
                                        fillOpacity: 0.8
                                    });
                                },
                                onEachFeature: function(feature, layer) {
                                    if (feature.properties && feature.properties.ISTASYON) {
                                        layer.bindPopup(`
                                            <div class="popup-content">
                                                <h6><i class="fas fa-tram text-info"></i> ${feature.properties.ISTASYON}</h6>
                                                <p class="mb-1"><strong>Hat:</strong> ${feature.properties.PROJE_ADI || 'Bilinmiyor'}</p>
                                                <p class="mb-1"><strong>Tür:</strong> ${feature.properties.HAT_TURU}</p>
                                                <p class="mb-0"><strong>Müdürlük:</strong> ${feature.properties.MUDURLUK || 'Bilinmiyor'}</p>
                                            </div>
                                        `);
                                    }
                                }
                            }).addTo(adminTramStationsLayer);
                        } else {
                            console.error(`Admin HTTP Error ${response.status} for ${line}:`, response.statusText);
                        }
                    } catch (error) {
                        console.error(`Admin Tramvay hattı yüklenemedi: ${line}`, error);
                    }
                }
            } catch (error) {
                console.error('Admin tramvay istasyonları yüklenirken hata:', error);
            }
        }

        // Admin metro istasyonlarını göster/gizle
        function toggleAdminMetroStations() {
            const checkbox = document.getElementById('adminShowMetroStations');
            if (adminMetroStationsLayer) {
                if (checkbox.checked) {
                    adminMap.addLayer(adminMetroStationsLayer);
                } else {
                    adminMap.removeLayer(adminMetroStationsLayer);
                }
            }
        }

        // Admin tramvay istasyonlarını göster/gizle
        function toggleAdminTramStations() {
            const checkbox = document.getElementById('adminShowTramStations');
            if (adminTramStationsLayer) {
                if (checkbox.checked) {
                    adminMap.addLayer(adminTramStationsLayer);
                } else {
                    adminMap.removeLayer(adminTramStationsLayer);
                }
            }
        }

        // Sayfa yüklendiğinde haritayı başlat
        document.addEventListener('DOMContentLoaded', function() {
            // Diğer başlatma kodları...
            
            // Admin haritasını başlat
            setTimeout(function() {
                initializeAdminMap();
            }, 1000); // Sayfa tamamen yüklendikten sonra haritayı başlat

            // Modern modal functionality
            initializeModernModal();
        });

        // Modern Modal Functions
        let currentStep = 1;
        let selectedRouteType = '';

        function initializeModernModal() {
            // Route type selection
            document.querySelectorAll('.route-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.route-type-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedRouteType = this.dataset.type;
                });
            });

            // Step navigation
            const nextBtn = document.getElementById('nextStepBtn');
            const prevBtn = document.getElementById('prevStepBtn');

            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (validateCurrentStep()) {
                        nextStep();
                    }
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    prevStep();
                });
            }

            // Modal reset when closed
            const modal = document.getElementById('addRouteModal');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    resetModal();
                });
            }
        }

        function nextStep() {
            if (currentStep < 3) {
                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('completed');

                currentStep++;

                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');

                updateStepNavigation();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');

                currentStep--;

                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('completed');

                updateStepNavigation();
            }
        }

        function updateStepNavigation() {
            const nextBtn = document.getElementById('nextStepBtn');
            const prevBtn = document.getElementById('prevStepBtn');
            const saveBtn = document.getElementById('saveRouteBtn');

            if (currentStep === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'flex';
            }

            if (currentStep === 3) {
                nextBtn.style.display = 'none';
                saveBtn.style.display = 'flex';
            } else {
                nextBtn.style.display = 'flex';
                saveBtn.style.display = 'none';
            }
        }

        function validateCurrentStep() {
            const currentStepContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            const requiredFields = currentStepContent.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            if (currentStep === 1 && !selectedRouteType) {
                showToast('Lütfen bir rota türü seçin', 'warning');
                isValid = false;
            }

            if (!isValid) {
                showToast('Lütfen tüm gerekli alanları doldurun', 'error');
            }

            return isValid;
        }

        function resetModal() {
            currentStep = 1;
            selectedRouteType = '';

            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelector('.step[data-step="1"]').classList.add('active');
            document.querySelector('.step-content[data-step="1"]').classList.add('active');

            document.getElementById('addRouteForm').reset();
            document.querySelectorAll('.route-type-option').forEach(opt => opt.classList.remove('selected'));

            updateStepNavigation();

            document.getElementById('routeStopsRepeater').innerHTML = '';
            document.getElementById('emptyStopsMessage').style.display = 'block';
        }

        // Enhanced addStopRow function for modern modal
        function addStopRow() {
            const container = document.getElementById('routeStopsRepeater');
            const emptyMessage = document.getElementById('emptyStopsMessage');
            const stopIndex = container.children.length;

            const stopRow = document.createElement('div');
            stopRow.className = 'stop-row';
            stopRow.innerHTML = `
                <div class="stop-item">
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <div class="stop-order-container">
                                <div class="stop-order-label">SIRA</div>
                                <div class="stop-number">${stopIndex + 1}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="text" class="form-control modern-input" 
                                       placeholder="Durak Adı" required>
                                <label>Durak Adı *</label>
                                <div class="input-icon">
                                    <i class="fas fa-map-pin"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="number" class="form-control modern-input" 
                                       step="0.000001" placeholder="Enlem" required>
                                <label>Enlem *</label>
                                <div class="input-icon">
                                    <i class="fas fa-location-dot"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <input type="number" class="form-control modern-input" 
                                       step="0.000001" placeholder="Boylam" required>
                                <label>Boylam *</label>
                                <div class="input-icon">
                                    <i class="fas fa-location-dot"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStopRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(stopRow);
            emptyMessage.style.display = 'none';

            // Add animation
            stopRow.style.animation = 'fadeInUp 0.3s ease';
        }

        function removeStopRow(button) {
            const stopRow = button.closest('.stop-row');
            const container = document.getElementById('routeStopsRepeater');
            const emptyMessage = document.getElementById('emptyStopsMessage');

            // Add remove animation
            stopRow.style.animation = 'fadeOutDown 0.3s ease';
            
            setTimeout(() => {
                stopRow.remove();
                
                // Update stop numbers
                const remainingStops = container.querySelectorAll('.stop-number');
                remainingStops.forEach((stopNum, index) => {
                    stopNum.textContent = index + 1;
                });

                // Show empty message if no stops
                if (container.children.length === 0) {
                    emptyMessage.style.display = 'block';
                }
            }, 300);
        }

        // Enhanced saveRoute function for modern modal
        async function saveRoute() {
            if (!validateCurrentStep()) {
                return;
            }

            const formData = {
                name: document.getElementById('routeName').value,
                description: document.getElementById('routeDescription').value,
                startLocation: document.getElementById('startLocation').value,
                endLocation: document.getElementById('endLocation').value,
                routeType: selectedRouteType,
                stops: []
            };

            // Collect stops data
            const stopRows = document.querySelectorAll('#routeStopsRepeater .stop-row');
            stopRows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input');
                formData.stops.push({
                    name: inputs[0].value,
                    latitude: parseFloat(inputs[1].value),
                    longitude: parseFloat(inputs[2].value),
                    order: index + 1
                });
            });

            try {
                // Show loading state
                const saveBtn = document.getElementById('saveRouteBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                saveBtn.disabled = true;

                const tokenStr = localStorage.getItem('token');
                const token = tokenStr ? JSON.parse(tokenStr) : {};
                const createdById = parseInt(token.userId || token.id || 1) || 1;

                const payload = {
                    "routeName": formData.name,
                    "description": formData.description || "string",
                    "startLocation": formData.startLocation,
                    "endLocation": formData.endLocation,
                    "createdById": createdById,
                    "stops": formData.stops.map(stop => ({
                        "stopName": stop.name,
                        "stopId": 0,
                        "latitude": stop.latitude,
                        "longitude": stop.longitude,
                        "order": stop.order
                    }))
                };

                const response = await fetch('https://localhost:7007/api/routes/CreateRouteWithStops', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast('Rota başarıyla eklendi!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addRouteModal')).hide();
                    loadRoutes(); // Refresh routes table
                } else {
                    throw new Error('Failed to save route');
                }
            } catch (error) {
                console.error('Error saving route:', error);
                showToast('Rota kaydedilirken hata oluştu', 'error');
            } finally {
                // Reset button state
                const saveBtn = document.getElementById('saveRouteBtn');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
    </script>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-tachometer-alt text-primary"></i> Admin Panel
                    </h1>
                    <p class="text-muted mb-0">Manage your transportation system</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card bg-primary text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="h5 mb-0" id="totalRoutes"></div>
                                    <div class="small">Total Routes</div>
                                </div>
                                <div class="fa-2x">
                                    <i class="fas fa-route"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card bg-success text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="h5 mb-0" id="totalStops"></div>
                                    <div class="small">Total Stops</div>
                                </div>
                                <div class="fa-2x">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card bg-info text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="h5 mb-0" id="totalTrips"></div>
                                    <div class="small">Total Trips</div>
                                </div>
                                <div class="fa-2x">
                                    <i class="fas fa-bus"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-3">
                    <div class="card bg-warning text-white h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="h5 mb-0" id="totalConnections"></div>
                                    <div class="small">Route Connections</div>
                                </div>
                                <div class="fa-2x">
                                    <i class="fas fa-link"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transportation Network Map -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-map text-primary"></i> Ulaşım Ağı Haritası
                            </h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="checkbox" class="btn-check" id="adminShowMetroStations" autocomplete="off" checked>
                                <label class="btn btn-outline-primary" for="adminShowMetroStations">
                                    <i class="fas fa-train"></i> Metro İstasyonları
                                </label>
                                
                                <input type="checkbox" class="btn-check" id="adminShowTramStations" autocomplete="off" checked>
                                <label class="btn btn-outline-info" for="adminShowTramStations">
                                    <i class="fas fa-tram"></i> Tramvay İstasyonları
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="adminMap" style="height: 500px; background: #f8f9fa; border-radius: 10px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <ul class="nav nav-tabs nav-fill" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="routes-tab" data-bs-toggle="tab" data-bs-target="#routes" type="button" role="tab">
                        <i class="fas fa-route"></i> Routes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stops-tab" data-bs-toggle="tab" data-bs-target="#stops" type="button" role="tab">
                        <i class="fas fa-map-marker-alt"></i> Stops
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trips-tab" data-bs-toggle="tab" data-bs-target="#trips" type="button" role="tab">
                        <i class="fas fa-bus"></i> Trips
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="routestops-tab" data-bs-toggle="tab" data-bs-target="#routestops" type="button" role="tab">
                        <i class="fas fa-link"></i> Route Stops
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="adminTabsContent">
                <!-- Routes Tab -->
                <div class="tab-pane fade show active" id="routes" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex align-items-center gap-2 flex-wrap justify-content-between">
                            <div class="d-flex align-items-center gap-2 flex-grow-1">
                                <h5 class="mb-0">
                                    <i class="fas fa-route text-primary"></i> Routes Management
                                </h5>
                            </div>
                            <div class="mx-auto">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRouteModal">
                                    <i class="fas fa-plus"></i> Add Route
                                </button>
                            </div>
                            <div class="ms-auto">
                                <select class="form-select form-select-sm" id="routesPageSize" onchange="changePageSize('routes')" style="width: 80px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>  
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Start Location</th>
                                            <th>End Location</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="routesTableBody">
                                        <!-- Sample Data -->
                                        <tr>
                                            <td>1</td>
                                            <td><span class="badge bg-primary">Route A</span></td>
                                            <td>Main city route</td>
                                            <td>Central Station</td>
                                            <td>Airport</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editRoute(1)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-primary" onclick="showRouteStops(1)">
														<i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteRoute(1)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td><span class="badge bg-success">Route B</span></td>
                                            <td>Suburban route</td>
                                            <td>Downtown</td>
                                            <td>Mall</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editRoute(2)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-primary" onclick="showRouteStops(2)">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteRoute(2)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination sadece altta -->
                            <div class="d-flex flex-column align-items-center mt-3">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 justify-content-center" id="routesPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-muted small mt-2" id="routesPaginationInfo">
                                    Showing 1 to 10 of 50 entries
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stops Tab -->
                <div class="tab-pane fade" id="stops" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex align-items-center gap-2 flex-wrap justify-content-between">
                            <div class="d-flex align-items-center gap-2 flex-grow-1">
                                <h5 class="mb-0">
                                    <i class="fas fa-map-marker-alt text-success"></i> Stops Management
                                </h5>
                            </div>
                            <div class="mx-auto">
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStopModal">
                                    <i class="fas fa-plus"></i> Add Stop
                                </button>
                            </div>
                            <div class="ms-auto">
                                <select class="form-select form-select-sm" id="stopsPageSize" onchange="changePageSize('stops')" style="width: 80px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Latitude</th>
                                            <th>Longitude</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stopsTableBody">
                                        <!-- Sample Data -->
                                        <tr>
                                            <td>1</td>
                                            <td><i class="fas fa-map-pin text-danger"></i> Central Station</td>
                                            <td>40.7128</td>
                                            <td>-74.0060</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editStop(1)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteStop(1)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td><i class="fas fa-map-pin text-danger"></i> Airport Terminal</td>
                                            <td>40.6892</td>
                                            <td>-74.1745</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editStop(2)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteStop(2)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination sadece altta -->
                            <div class="d-flex flex-column align-items-center mt-3">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 justify-content-center" id="stopsPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-muted small mt-2" id="stopsPaginationInfo">
                                    Showing 1 to 10 of 50 entries
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trips Tab -->
                <div class="tab-pane fade" id="trips" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex align-items-center gap-2 flex-wrap justify-content-between">
                            <div class="d-flex align-items-center gap-2 flex-grow-1">
                                <h5 class="mb-0">
                                    <i class="fas fa-bus text-info"></i> Trips Management
                                </h5>
                            </div>
                            <div class="mx-auto">
                                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addTripModal">
                                    <i class="fas fa-plus"></i> Add Trip
                                </button>
                            </div>
                            <div class="ms-auto">
                                <select class="form-select form-select-sm" id="tripsPageSize" onchange="changePageSize('trips')" style="width: 80px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Route</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Day Type</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tripsTableBody">
                                        <!-- Sample Data -->
                                        <tr>
                                            <td>1</td>
                                            <td><span class="badge bg-primary">Route A</span></td>
                                            <td>08:00</td>
                                            <td>09:30</td>
                                            <td><span class="badge bg-success">Weekday</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editTrip(1)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteTrip(1)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td><span class="badge bg-success">Route B</span></td>
                                            <td>09:15</td>
                                            <td>10:45</td>
                                            <td><span class="badge bg-warning">Weekend</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editTrip(2)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteTrip(2)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination sadece altta -->
                            <div class="d-flex flex-column align-items-center mt-3">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 justify-content-center" id="tripsPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-muted small mt-2" id="tripsPaginationInfo">
                                    Showing 1 to 10 of 50 entries
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Route Stops Tab -->
                <div class="tab-pane fade" id="routestops" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex align-items-center gap-2 flex-wrap justify-content-between">
                            <div class="d-flex align-items-center gap-2 flex-grow-1">
                                <h5 class="mb-0">
                                    <i class="fas fa-link text-warning"></i> Route Stops Management
                                </h5>
                            </div>
                            <div class="mx-auto">
                                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addRouteStopModal">
                                    <i class="fas fa-plus"></i> Add Route Stop
                                </button>
                            </div>
                            <div class="ms-auto">
                                <select class="form-select form-select-sm" id="routeStopsPageSize" onchange="changePageSize('routeStops')" style="width: 80px;">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Route</th>
                                            <th>Stop</th>
                                            <th>Order</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="routeStopsTableBody">
                                        <!-- Sample Data -->
                                        <tr>
                                            <td>1</td>
                                            <td><span class="badge bg-primary">Route A</span></td>
                                            <td><i class="fas fa-map-pin text-danger"></i> Central Station</td>
                                            <td><span class="badge bg-secondary">1</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editRouteStop(1)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteRouteStop(1)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td><span class="badge bg-primary">Route A</span></td>
                                            <td><i class="fas fa-map-pin text-danger"></i> Airport Terminal</td>
                                            <td><span class="badge bg-secondary">2</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info" onclick="editRouteStop(2)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteRouteStop(2)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination sadece altta -->
                            <div class="d-flex flex-column align-items-center mt-3">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0 justify-content-center" id="routeStopsPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="text-muted small mt-2" id="routeStopsPaginationInfo">
                                    Showing 1 to 10 of 50 entries
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Modals {
<!-- Add Route Modal - Modern Design -->
<div class="modal fade" id="addRouteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modern-modal-content">
            <!-- Modern Header with Gradient -->
            <div class="modal-header modern-modal-header">
                <div class="modal-title-container">
                    <div class="modal-icon-wrapper">
                        <i class="fas fa-route"></i>
                    </div>
                    <div>
                        <h4 class="modal-title mb-0">Yeni Rota Ekle</h4>
                        <p class="modal-subtitle mb-0">Toplu taşıma rotası oluşturun</p>
                    </div>
                </div>
                <button type="button" class="btn-close modern-btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modern Body with Steps -->
            <div class="modal-body modern-modal-body">
                <!-- Progress Steps -->
                <div class="progress-steps mb-4">
                    <div class="step active" data-step="1">
                        <div class="step-icon"><i class="fas fa-info-circle"></i></div>
                        <span class="step-label">Temel Bilgiler</span>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <span class="step-label">Konum Bilgileri</span>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-icon"><i class="fas fa-map-pin"></i></div>
                        <span class="step-label">Duraklar</span>
                    </div>
                </div>

                <form id="addRouteForm">
                    <!-- Step 1: Basic Information -->
                    <div class="step-content active" data-step="1">
                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="fas fa-info-circle text-primary"></i>
                                Temel Bilgiler
                            </h6>
                            
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control modern-input" id="routeName" placeholder="Rota Adı" required>
                                <label for="routeName">Rota Adı *</label>
                                <div class="input-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <textarea class="form-control modern-input" id="routeDescription" placeholder="Açıklama" rows="3" style="height: 100px;"></textarea>
                                <label for="routeDescription">Açıklama</label>
                                <div class="input-icon">
                                    <i class="fas fa-align-left"></i>
                                </div>
                            </div>

                            <!-- Route Type Selection -->
                            <div class="mb-3">
                                <label class="form-label section-label">Rota Türü *</label>
                                <div class="route-type-selector">
                                    <div class="route-type-option" data-type="bus">
                                        <i class="fas fa-bus"></i>
                                        <span>Otobüs</span>
                                    </div>
                                    <div class="route-type-option" data-type="metro">
                                        <i class="fas fa-train"></i>
                                        <span>Metro</span>
                                    </div>
                                    <div class="route-type-option" data-type="tram">
                                        <i class="fas fa-tram"></i>
                                        <span>Tramvay</span>
                                    </div>
                                    <div class="route-type-option" data-type="metrobus">
                                        <i class="fas fa-subway"></i>
                                        <span>Metrobüs</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Location Information -->
                    <div class="step-content" data-step="2">
                        <div class="form-section">
                            <h6 class="section-title">
                                <i class="fas fa-map-marker-alt text-success"></i>
                                Konum Bilgileri
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control modern-input" id="startLocation" placeholder="Başlangıç Lokasyonu" required>
                                        <label for="startLocation">Başlangıç Lokasyonu *</label>
                                        <div class="input-icon">
                                            <i class="fas fa-play text-success"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control modern-input" id="endLocation" placeholder="Bitiş Lokasyonu" required>
                                        <label for="endLocation">Bitiş Lokasyonu *</label>
                                        <div class="input-icon">
                                            <i class="fas fa-stop text-danger"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>

                    <!-- Step 3: Stops -->
                    <div class="step-content" data-step="3">
                        <div class="form-section">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h6 class="section-title mb-0">
                                    <i class="fas fa-map-pin text-warning"></i>
                                    Duraklar
                                </h6>
                                <button type="button" class="btn btn-modern btn-add-stop" onclick="addStopRow()">
                                    <i class="fas fa-plus"></i>
                                    Durak Ekle
                                </button>
                            </div>
                            
                            <div class="stops-container">
                                <div id="routeStopsRepeater" class="stops-list"></div>
                                <div class="empty-stops-message" id="emptyStopsMessage">
                                    <i class="fas fa-map-pin mb-2"></i>
                                    <p>Henüz durak eklenmedi</p>
                                    <small class="text-muted">Rotanıza durak eklemek için "Durak Ekle" butonunu kullanın</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Modern Footer with Step Navigation -->
            <div class="modal-footer modern-modal-footer">
                <div class="step-navigation">
                    <button type="button" class="btn btn-modern btn-secondary" id="prevStepBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i>
                        Önceki
                    </button>
                    
                    <div class="footer-buttons">
                        <button type="button" class="btn btn-modern btn-cancel" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i>
                            İptal
                        </button>
                        
                        <button type="button" class="btn btn-modern btn-primary" id="nextStepBtn">
                            Sonraki
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        
                        <button type="button" class="btn btn-modern btn-success" id="saveRouteBtn" onclick="saveRoute()" style="display: none;">
                            <i class="fas fa-save"></i>
                            Rotayı Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Stop Modal -->
<div class="modal fade" id="addStopModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add New Stop
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStopForm">
                    <div class="mb-3">
                        <label for="stopName" class="form-label">Stop Name *</label>
                        <input type="text" class="form-control" id="stopName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stopLatitude" class="form-label">Latitude *</label>
                                <input type="number" class="form-control" id="stopLatitude" step="0.000001" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stopLongitude" class="form-label">Longitude *</label>
                                <input type="number" class="form-control" id="stopLongitude" step="0.000001" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="saveStop()">
                    <i class="fas fa-save"></i> Save Stop
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Trip Modal -->
<div class="modal fade" id="addTripModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add New Trip
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTripForm">
                    <div class="mb-3">
                        <label for="tripRoute" class="form-label">Route *</label>
                        <select class="form-select" id="tripRoute" required>
                            <option value="">Select a route</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time *</label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time *</label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="dayType" class="form-label">Day Type *</label>
                        <select class="form-select" id="dayType" required>
                            <option value="">Select day type</option>
                            <option value="weekday">Weekday</option>
                            <option value="saturday">Saturday</option>
                            <option value="sunday">Sunday</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-info" onclick="saveTrip()">
                    <i class="fas fa-save"></i> Save Trip
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Route Stop Modal -->
<div class="modal fade" id="addRouteStopModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add Route Stop Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRouteStopForm">
                    <div class="mb-3">
                        <label for="routeStopRoute" class="form-label">Route *</label>
                        <select class="form-select" id="routeStopRoute" required>
                            <option value="">Select a route</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="routeStopStop" class="form-label">Stop *</label>
                        <select class="form-select" id="routeStopStop" required>
                            <option value="">Select a stop</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="stopOrder" class="form-label">Order *</label>
                        <input type="number" class="form-control" id="stopOrder" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-warning" onclick="saveRouteStop()">
                    <i class="fas fa-save"></i> Save Connection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Route Modal -->
<div class="modal fade" id="updateRouteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Update Route
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateRouteForm">
                    <input type="hidden" id="updateRouteId">
                    <div class="mb-3">
                        <label for="updateRouteName" class="form-label">Route Name *</label>
                        <input type="text" class="form-control" id="updateRouteName" required>
                    </div>
                    <div class="mb-3">
                        <label for="updateRouteDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="updateRouteDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="updateStartLocation" class="form-label">Start Location *</label>
                                <input type="text" class="form-control" id="updateStartLocation" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="updateEndLocation" class="form-label">End Location *</label>
                                <input type="text" class="form-control" id="updateEndLocation" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-info" onclick="updateRoute()">
                    <i class="fas fa-save"></i> Update Route
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Stop Modal -->
<div class="modal fade" id="updateStopModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Update Stop
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStopForm">
                    <input type="hidden" id="updateStopId">
                    <div class="mb-3">
                        <label for="updateStopName" class="form-label">Stop Name *</label>
                        <input type="text" class="form-control" id="updateStopName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="updateStopLatitude" class="form-label">Latitude *</label>
                                <input type="number" class="form-control" id="updateStopLatitude" step="0.000001" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="updateStopLongitude" class="form-label">Longitude *</label>
                                <input type="number" class="form-control" id="updateStopLongitude" step="0.000001" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-warning" onclick="updateStop()">
                    <i class="fas fa-save"></i> Update Stop
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Trip Modal -->
<div class="modal fade" id="updateTripModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Update Trip
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateTripForm">
                    <input type="hidden" id="updateTripId">
                    <div class="mb-3">
                        <label for="updateTripRoute" class="form-label">Route *</label>
                        <select class="form-select" id="updateTripRoute" required>
                            <option value="">Select a route</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="updateStartTime" class="form-label">Start Time *</label>
                                <input type="time" class="form-control" id="updateStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="updateEndTime" class="form-label">End Time *</label>
                                <input type="time" class="form-control" id="updateEndTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="updateDayType" class="form-label">Day Type *</label>
                        <select class="form-select" id="updateDayType" required>
                            <option value="">Select day type</option>
                            <option value="Hafta İçi">Hafta İçi</option>
                            <option value="Hafta Sonu">Hafta Sonu</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="updateTrip()">
                    <i class="fas fa-save"></i> Update Trip
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Route Stop Modal -->
<div class="modal fade" id="updateRouteStopModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Update Route Stop
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateRouteStopForm">
                    <input type="hidden" id="updateRouteStopId">
                    <div class="mb-3">
                        <label for="updateRouteStopRoute" class="form-label">Route *</label>
                        <select class="form-select" id="updateRouteStopRoute" required>
                            <option value="">Select a route</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="updateRouteStopStop" class="form-label">Stop *</label>
                        <select class="form-select" id="updateRouteStopStop" required>
                            <option value="">Select a stop</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="updateStopOrder" class="form-label">Order *</label>
                        <input type="number" class="form-control" id="updateStopOrder" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" onclick="updateRouteStop()">
                    <i class="fas fa-save"></i> Update Route Stop
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog"></i> Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Theme Settings</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="theme" id="lightTheme" value="light">
                        <label class="form-check-label" for="lightTheme">Light Theme</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="theme" id="darkTheme" value="dark">
                        <label class="form-check-label" for="darkTheme">Dark Theme</label>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Auto Refresh</h6>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh">
                        <label class="form-check-label" for="autoRefresh">Enable auto refresh (30s)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>
</div>
<!-- Modern Route Stops Modal -->
<div class="modal fade" id="routeStopsModal" tabindex="-1" aria-labelledby="routeStopsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="routeStopsModalLabel">
                    <i class="fas fa-map-marker-alt"></i> Route Durakları
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">
                                    <i class="fas fa-sort-numeric-up me-2"></i>Sıra
                                </th>
                                <th scope="col">
                                    <i class="fas fa-map-marker-alt me-2"></i>Durak Adı
                                </th>
                                <th scope="col">
                                    <i class="fas fa-location-dot me-2"></i>Konum
                                </th>
                            </tr>
                        </thead>
                        <tbody id="routeStopsModalBody">
                            <!-- Route stops will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Kapat
                </button>
            </div>
        </div>
    </div>
</div>
}

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>



@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .card {
            transition: transform 0.2s ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .table th {
            border-top: none;
        }
        
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary-rgb));
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #fff;
            border-bottom: 3px solid var(--bs-primary);
            color: var(--bs-primary);
            font-weight: 600;
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(0,0,0,.125);
        }
        
        .toast {
            min-width: 300px;
        }
        /* Toast container her zaman üstte ve görünür olsun */
        #toastContainer {
            z-index: 999999 !important;
            position: fixed !important;
            bottom: 1.5rem;
            right: 1.5rem;
            pointer-events: none;
        }
        #toastContainer .toast {
            pointer-events: auto;
        }
        
        @@media (max-width: 768px) {
            .btn-group-sm {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
        }

        /* Göz butonu için özel stil */
        .btn-outline-primary {
            color: #6c757d;
            border-color: #6c757d;
        }

            .btn-outline-primary:hover {
                color: #fff;
                background-color: #0d6efd;
                border-color: #0d6efd;
            }

        /* Modal için genişlik ayarı */
        .modal-lg {
            max-width: 800px;
        }

        /* Modern modal stilleri artık adminpanel.css dosyasında tanımlı */

        /* Harita popup stilleri */
        .popup-content {
            min-width: 220px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .popup-content h6 {
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.25rem;
        }

        .popup-content p {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .popup-content p:last-child {
            margin-bottom: 0;
        }

        /* Leaflet popup özelleştirme */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .leaflet-popup-tip {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Modern Modal Styles */
        .modern-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .modern-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 2rem 2rem 1.5rem;
            position: relative;
        }

        .modern-modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            backdrop-filter: blur(10px);
        }

        .modal-title-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            z-index: 2;
        }

        .modal-icon-wrapper {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .modal-icon-wrapper i {
            font-size: 1.5rem;
            color: white;
        }

        .modern-modal-header h4 {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 400;
        }

        .modern-btn-close {
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modern-btn-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modern-modal-body {
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 2rem;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 25px;
            right: 25px;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .step.active .step-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: rgba(102, 126, 234, 0.3);
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .step.completed .step-icon {
            background: #28a745;
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6c757d;
            text-align: center;
            transition: all 0.3s ease;
        }

        .step.active .step-label {
            color: #495057;
            font-weight: 600;
        }

        /* Form Sections */
        .form-section {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
        }

        /* Modern Input Styles */
        .modern-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.75rem 3rem 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .modern-input:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: translateY(-2px);
        }

        .form-floating .modern-input:focus ~ label {
            color: #667eea;
        }

        .form-floating > .input-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 1rem;
            z-index: 4;
            transition: all 0.3s ease;
        }

        .form-floating:focus-within > .input-icon {
            color: #667eea;
            transform: translateY(-50%) scale(1.1);
        }

        /* Route Type Selector */
        .route-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .route-type-option {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .route-type-option:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .route-type-option.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .route-type-option i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .route-type-option span {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Step Content */
        .step-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .step-content.active {
            display: block;
        }

                    @@keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @@keyframes fadeOutDown {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(20px);
                }
            }

        /* Stops Container */
        .stops-container {
            min-height: 200px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(102, 126, 234, 0.3);
        }

        .empty-stops-message {
            text-align: center;
            color: #6c757d;
            padding: 2rem;
        }

        .empty-stops-message i {
            font-size: 3rem;
            color: #dee2e6;
        }

        .stops-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Modern Footer */
        .modern-modal-footer {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            padding: 1.5rem 2rem;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .footer-buttons {
            display: flex;
            gap: 1rem;
            margin-left: auto;
        }

        /* Modern Buttons */
        .btn-modern {
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-modern.btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-modern.btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-modern.btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-modern.btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-modern.btn-secondary {
            background: rgba(108, 117, 125, 0.9);
            color: white;
        }

        .btn-modern.btn-secondary:hover {
            background: rgba(108, 117, 125, 1);
            transform: translateY(-2px);
        }

        .btn-modern.btn-cancel {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .btn-modern.btn-cancel:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }

        .btn-add-stop {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            border: none;
        }

        .btn-add-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
        }

        /* Stop Row Styles */
        .stop-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .stop-item:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stop-number {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border: 3px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            margin: 0 auto;
        }

        .stop-number:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .stop-order-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #667eea;
            text-align: center;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stop-order-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Responsive Design */
        @@media (max-width: 768px) {
            .modern-modal-header {
                padding: 1.5rem 1rem 1rem;
            }

            .modern-modal-body {
                padding: 1rem;
            }

            .modal-title-container {
                gap: 0.5rem;
            }

            .modal-icon-wrapper {
                width: 40px;
                height: 40px;
            }

            .modern-modal-header h4 {
                font-size: 1.2rem;
            }

            .route-type-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .progress-steps {
                flex-direction: column;
                gap: 1rem;
            }

            .progress-steps::before {
                display: none;
            }

            .step {
                flex-direction: row;
                width: 100%;
                justify-content: flex-start;
                text-align: left;
            }

            .footer-buttons {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .step-navigation {
                flex-direction: column;
                gap: 1rem;
            }

            .stop-number {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }
            
            </style>
    
    <!-- AdminPanel özel CSS dosyası -->
    <link rel="stylesheet" href="~/css/adminpanel.css" asp-append-version="true" />
}
