@model internshipProject1.WebUI.Views.Account.LoginModel
@{
	ViewData["Title"] = "Giriş Yap";
	Layout = "_Layout";
}

<!-- Error Message Display -->
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger" role="alert">
        @TempData["ErrorMessage"]
    </div>
}

<div class="auth-wrapper">
    <div class="auth-welcome-panel">
        <div class="welcome-content">
            <h1>Tekrar Hoş Geldiniz!</h1>
            <p>Projenize kaldığınız yerden devam etmek için giriş yapın.</p>
        </div>
    </div>
    <div class="auth-form-container">
        <div class="auth-form-content">
            <h2>Giriş Yap</h2>
            <p class="auth-subtitle">Hesabınıza erişim sağlayın</p>

            <div id="error" class="alert alert-danger" style="display: none;"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Kullanıcı Adı</label>
                    <input type="text" id="username" name="username" required />
                </div>
                <div class="form-group">
                    <label for="password">Şifre</label>
                    <input type="password" id="password" name="password" required />
                </div>
                <div class="form-group remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe" />
                    <label for="rememberMe">Beni Hatırla</label>
                </div>

                <button type="submit" class="auth-btn">
                    Giriş Yap
                </button>
            </form>

            <div class="auth-footer">
                <p>Hesabınız yok mu? <a href="/Account/Register">Kayıt Olun</a></p>
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('rememberMe').checked;

    const button = document.querySelector('#loginForm .auth-btn');
    const originalText = button.textContent;
    
    button.disabled = true;
    button.textContent = 'Giriş yapılıyor...';

    try {
        const response = await fetch(`${window.gatewayUrl}/api/user/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Api-Key': window.apiKey
            },
            body: JSON.stringify({ userName: username, password: password })
        });

        if (!response.ok) {
            throw new Error('Kullanıcı adı veya şifre hatalı.');
        }

        const data = await response.json();
        console.log('Login response:', data);

        // Sunucu tarafında session ve cookie oluşturmak için SetSession endpoint'ini çağır
        const sessionResponse = await fetch('/Account/SetSession', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                Token: data.token.accessToken,
                Username: data.userName,
                Role: data.role.toString(),
                UserId: data.id.toString(),
                Email: data.email.toString()
            })
        });

        const sessionResult = await sessionResponse.json();
        if (!sessionResult.success) {
            throw new Error(sessionResult.error || 'Session could not be set.');
        }
        
        console.log('Session and cookie set successfully.');

        // Token'ı ve kullanıcı bilgilerini localStorage'a kaydet
        const tokenData = {
            token: data.token,
            accessToken: data.token.accessToken,
            refreshToken: data.token.refreshToken,
            username: data.userName,
            userId: data.id, // userId'yi de kaydet
            role: data.role,
            email: data.email,
            loginTime: new Date().getTime(),
            rememberMe: rememberMe
        };
        
        // Remember me özelliği için token süresini ayarla
        if (rememberMe) {
            // Beni hatırla seçiliyse token'ı daha uzun süre sakla
            console.log('Remember me aktif - token uzun süreli saklanacak');
        } else {
            // Beni hatırla seçili değilse session süresince sakla
            console.log('Remember me pasif - token session süresince saklanacak');
        }
        
        console.log('Token data to be saved:', tokenData);
        
        localStorage.setItem('token', JSON.stringify(tokenData));
        
        // API istekleri için token'ı header'a ekle
        if (window.App && typeof window.App.setAuthToken === 'function') {
            window.App.setAuthToken(data.token.accessToken);
        }
        
        // Navbar'ı güncelle
        if (window.App && typeof window.App.updateNavbar === 'function') {
            window.App.updateNavbar();
        }

        button.textContent = 'Giriş başarılı!';
        
        setTimeout(() => {
            if (data.role === 1) { // Admin
                window.location.href = '/AdminPanel/AdminMainPage';
            } else { // Normal kullanıcı
                window.location.href = '/User/Dashboard';
            }
        }, 1000);
        
    } catch (error) {
        console.error('Login Error:', error);
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = error.message || 'Bir hata oluştu. Lütfen tekrar deneyin.';
        errorDiv.style.display = 'block';
        
        button.textContent = 'Giriş başarısız';
        
        setTimeout(() => {
            button.disabled = false;
            button.textContent = originalText;
            errorDiv.style.display = 'none';
        }, 3000);
    }
});

// Sayfa yüklendiğinde remember me durumunu kontrol et
document.addEventListener('DOMContentLoaded', function() {
    const rememberMeCheckbox = document.getElementById('rememberMe');
    const savedRememberMe = localStorage.getItem('rememberMe');
    
    if (savedRememberMe === 'true') {
        rememberMeCheckbox.checked = true;
    }
    
    // Remember me checkbox değiştiğinde localStorage'a kaydet
    rememberMeCheckbox.addEventListener('change', function() {
        localStorage.setItem('rememberMe', this.checked);
    });
});
</script>


@section Styles {
    <link rel="stylesheet" href="~/css/auth.css" />
}